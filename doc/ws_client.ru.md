```markdown
# Документация DOM Command Client v4.2

## Обзор

DOM Command Client версии 4.2 обеспечивает доставку и выполнение команд управления интерфейсом от сервера SvxLink Dashboard в реальном времени. Клиент автоматически устанавливает канал связи с сервером команд, обрабатывает инструкции по обновлению DOM и поддерживает визуальную индикацию состояния соединения.

## Архитектура

### Основные компоненты

- **DashboardDomCommandClientV4** - основной класс клиента
- **Менеджер транспортного соединения** - управление каналом связи с сервером команд
- **Исполнитель DOM-команд** - выполнение инструкций по модификации интерфейса
- **Интерфейс статуса** - кнопка визуальной индикации в навигации
- **Система логирования** - отображение отладочной информации в веб-консоли

### Состояния транспортного соединения

- **connected** - канал связи с сервером команд установлен
- **connecting** - установка соединения
- **reconnecting** - повторное подключение после разрыва
- **disconnected** - ручное отключение
- **error** - ошибка соединения
- **timeout** - таймаут подключения

## Конфигурация

### Параметры по умолчанию

```javascript
{
  host: window.location.hostname,  // Хост сервера команд
  port: 8080,                      // Порт сервера команд
  autoConnect: true,               // Автоподключение при загрузке
  reconnectDelay: 3000,            // Задержка переподключения (мс)
  debugLevel: 2,                  // Уровень логирования: 1=ERROR, 2=WARNING, 3=INFO, 4=DEBUG
  debugWebConsole: true,          // Логи в веб-консоль
  debugConsole: false,           // Логи в console браузера
  maxReconnectAttempts: 5,       // Макс. попыток переподключения
  pingInterval: 30000           // Интервал проверки связи (мс)
}
```

### Получение конфигурации

Клиент ожидает конфигурацию в глобальной переменной:
```javascript
window.DASHBOARD_CONFIG = {
  commandServer: {
    host: "192.168.1.100",
    port: 8080,
    // ... другие параметры
  }
};
```

## Методы класса

### Инициализация и управление соединением

`constructor(config = {})`

**Назначение:** Создание экземпляра клиента команд.

**Параметры:**
- `config` (Object) - конфигурация клиента

**Действия:**
- Инициализация конфигурации с значениями по умолчанию
- Создание статусной кнопки в навигации
- Автоматическое подключение (если `autoConnect: true`)

---

`connect()`

**Назначение:** Установка канала связи с сервером команд.

**Действия:**
- Сброс флага ручного отключения
- Закрытие существующего соединения (если есть)
- Создание нового транспортного соединения
- Установка обработчиков событий
- Настройка таймаута подключения (5 секунд)
- Обновление статуса на "connecting"

**Возвращает:** `true` при успешной попытке подключения, `false` при ошибке

---

`disconnect()`

**Назначение:** Ручное закрытие канала связи.

**Действия:**
- Установка флага ручного отключения
- Закрытие транспортного соединения с кодом 1000
- Очистка таймеров
- Обновление статуса на "disconnected"
- Логирование действия

---

`reconnect()`

**Назначение:** Автоматическое восстановление канала связи.

**Действия:**
- Проверка на ручное отключение (прерывание)
- Увеличение счетчика попыток
- Расчет экспоненциальной задержки
- Логирование информации о переподключении
- Обновление статуса на "reconnecting"
- Запуск таймера для нового подключения

---

`scheduleReconnect()`

**Назначение:** Планирование следующей попытки восстановления связи.

**Действия:**
- Проверка максимального количества попыток
- Вызов `reconnect()` или установка статуса "error"

### Обработчики событий транспорта

`handleOpen(event)`

**Назначение:** Обработка успешного установления канала связи.

**Действия:**
- Логирование успешного подключения
- Сброс счетчика попыток переподключения
- Обновление статуса на "connected"
- Запуск таймера проверки связи

---

`handleMessage(event)`

**Назначение:** Обработка входящих сообщений от сервера команд.

**Обрабатывает:**
- **welcome** - приветственное сообщение с версией и ID клиента
- **pong** - ответ на проверку связи
- **dom_commands** - пакет команд для выполнения
- **log_message** - отладочные сообщения с сервера
- **массив команд** - прямая передача команд (для совместимости)

**Действия:**
- Парсинг JSON данных
- Маршрутизация сообщений по типам
- Фильтрация логов по уровню отладки
- Выполнение команд DOM через `processCommands()`

---

`handleClose(event)`

**Назначение:** Обработка закрытия транспортного соединения.

**Действия:**
- Логирование кода и причины закрытия
- Очистка таймеров
- Проверка на ручное отключение
- Запуск восстановления связи (если не ручное отключение)

---

`handleError(error)`

**Назначение:** Обработка ошибок транспортного соединения.

**Действия:**
- Логирование ошибки
- Обновление статуса на "error"

### Обработка DOM команд

`processCommands(commands, chunkNum, totalChunks)`

**Назначение:** Основной метод обработки пакетов команд.

**Параметры:**
- `commands` (Array) - массив команд для выполнения
- `chunkNum` (Number) - номер текущего фрагмента (опционально)
- `totalChunks` (Number) - общее количество фрагментов (опционально)

**Действия:**
- Валидация входных данных
- Логирование информации о фрагментации
- Последовательное выполнение команд через `executeAction()`
- Подсчет успешных и неудачных операций
- Логирование результатов выполнения

---

`executeAction(cmd)`

**Назначение:** Выполнение одиночной команды модификации DOM.

**Параметры:**
- `cmd` (Object) - объект команды

**Действия:**
- Валидация обязательных полей
- Маршрутизация по типу действия
- Вызов соответствующего метода обработки
- Возврат результата выполнения

**Возвращает:** `true` при успешном выполнении, `false` при ошибке

### Основные операции DOM

`handleAddClass(cmd)`

**Назначение:** Добавление класса(ов) к элементу.

**Параметры команды:**
- `id` (String) - ID целевого элемента
- `class` (String) - класс или список классов через запятую

**Действия:**
- Поиск элемента по ID
- Добавление одного или нескольких классов
- Логирование операции

---

`handleRemoveClass(cmd)`

**Назначение:** Удаление класса(ов) из элемента.

**Параметры команды:**
- `id` (String) - ID целевого элемента
- `class` (String) - класс или список классов через запятую

**Действия:**
- Поиск элемента по ID
- Удаление одного или нескольких классов
- Логирование операции

---

`handleSetContent(cmd)`

**Назначение:** Полная замена содержимого элемента.

**Параметры команды:**
- `id` (String) - ID целевого элемента
- `payload` (String) - новое HTML содержимое

**Действия:**
- Поиск элемента по ID
- Установка нового содержимого через `innerHTML`
- Логирование операции (обрезание длинного контента)

---

`handleReplaceContent(cmd)`

**Назначение:** Частичная замена содержимого элемента.

**Параметры команды:**
- `id` (String) - ID целевого элемента
- `payload` (Array) - массив из трех элементов:
  + `beginCond` - открывающая последовательность для поиска
  + `endCond` - закрывающая последовательность для поиска
  + `newContent` - новое содержимое для вставки

**Действия:**
- Поиск элемента по ID
- Поиск позиций открывающей и закрывающей последовательностей
- Замена содержимого между последовательностями
- Логирование операции

---

`handleRemoveElement(cmd)`

**Назначение:** Удаление элемента из DOM.

**Параметры команды:**
- `id` (String) - ID элемента для удаления

**Действия:**
- Поиск элемента по ID
- Вызов метода `remove()`
- Логирование операции

### Родительские операции

`handleParentClass(cmd, operation)`

**Назначение:** Добавление или удаление класса у родительского элемента.

**Параметры команды:**
- `id` (String) - ID дочернего элемента
- `class` (String) - класс или список классов через запятую
- `action` (String) - тип операции: `add_parent_class` или `remove_parent_class`

**Действия:**
- Поиск родительского элемента через `parentElement`
- Добавление или удаление классов
- Логирование операции

### Операции над дочерними элементами

`addChild(cmd)`

**Назначение:** Добавление дочернего элемента.

**Параметры команды:**
- `target` (String) - ID родительского элемента
- `payload` (String) - HTML содержимое нового элемента
- `type` (String) - тип элемента (по умолчанию 'div')
- `id` (String) - ID нового элемента (опционально)
- `class` (String) - класс нового элемента (опционально)
- `style` (String) - inline стили (опционально)
- `title` (String) - title атрибут (опционально)

**Действия:**
- Поиск родительского элемента
- Проверка существования элемента с таким ID
- Создание нового элемента с указанными параметрами
- Добавление элемента к родителю
- Логирование операции

---

`removeChild(cmd)`

**Назначение:** Удаление дочерних элементов с фильтрацией.

**Параметры команды:**
- `id` (String) - ID родительского элемента
- `ignoreClass` (String) - классы, которые НЕ должны удаляться (через запятую)

**Действия:**
- Поиск родительского элемента
- Получение всех дочерних элементов
- Удаление элементов, у которых нет указанных в `ignoreClass` классов
- Логирование операции

---

`replaceChildClasses(cmd)`

**Назначение:** Замена классов у всех дочерних элементов первого уровня.

**Параметры команды:**
- `id` (String) - ID родительского элемента
- `oldClass` (String) - старые классы для замены (через запятую)
- `class` (String) - новые классы для установки (через запятую)

**Действия:**
- Поиск родительского элемента
- Получение всех дочерних элементов первого уровня
- Проверка наличия ВСЕХ старых классов у каждого элемента
- Замена старых классов на новые (для соответствующих элементов)
- Логирование количества измененных элементов

### Специальные операции

`handleSetCheckboxState(cmd)`

**Назначение:** Синхронизация состояния чекбокса.

**Параметры команды:**
- `id` (String) - ID элемента чекбокса
- `state` (String) - состояние: 'on' или 'off'

**Действия:**
- Поиск элемента чекбокса
- Преобразование строкового состояния в boolean
- Установка свойства `checked`
- Логирование операции (в режиме отладки)

### Вспомогательные методы

#### Управление элементами DOM

`getElement(id)`

**Назначение:** Поиск элемента по ID.

**Параметры:**
- `id` (String) - ID элемента

**Возвращает:** DOM элемент или `null`

**Действия:**
- Поиск через `document.getElementById()`
- Логирование предупреждения при отсутствии элемента (уровень 2+)

---

`getParentElement(childId)`

**Назначение:** Поиск родительского элемента.

**Параметры:**
- `childId` (String) - ID дочернего элемента

**Возвращает:** Родительский DOM элемент или `null`

**Действия:**
- Поиск дочернего элемента
- Получение родительского элемента через `parentElement`

#### Управление таймерами

`startPingTimer()`

**Назначение:** Запуск таймера для проверки связи с сервером.

**Действия:**
- Очистка существующего таймера
- Установка интервального таймера
- Отправка сигнала проверки связи на сервер
- Логирование в режиме отладки

---

`clearTimers()`

**Назначение:** Очистка всех активных таймеров.

**Действия:**
- Остановка таймера проверки связи
- Остановка таймера восстановления соединения

#### Управление статусом

`updateStatus(status, message)`

**Назначение:** Обновление визуального состояния соединения.

**Параметры:**
- `status` (String) - новое состояние соединения
- `message` (String) - сообщение для отображения

**Действия:**
- Обновление внутреннего состояния
- Логирование изменения статуса
- Обновление текста и стилей статусной кнопки
- Установка соответствующего tooltip

---

`createStatusButton()`

**Назначение:** Создание кнопки статуса в навигации.

**Действия:**
- Удаление старой кнопки (если есть)
- Поиск навигационной панели
- Создание новой кнопки с обработчиком клика
- Добавление кнопки в DOM
- Логирование создания

---

`handleStatusButton()`

**Назначение:** Обработка клика по статусной кнопке.

**Действия в зависимости от состояния:**
- **connected** - ручное отключение (`disconnect()`)
- **disconnected/error/timeout** - перезагрузка страницы
- **connecting/reconnecting** - игнорирование клика

---

`startPageReload()`

**Назначение:** Инициирование перезагрузки страницы.

**Действия:**
- Логирование начала перезагрузки
- Обновление текста статусной кнопки
- Перезагрузка страницы через 300 мс

#### Логирование

`log(level, message, data)`

**Назначение:** Многоуровневое логирование.

**Параметры:**
- `level` (String|Number) - уровень логирования
- `message` (String) - текстовое сообщение
- `data` (Any) - дополнительные данные (опционально)

**Уровни логирования:**
1. **ERROR** - критические ошибки
2. **WARNING** - предупреждения
3. **INFO** - информационные сообщения (по умолчанию)
4. **DEBUG** - детальная отладочная информация

**Действия:**
- Проверка уровня отладки конфигурации
- Логирование в консоль браузера (если включено)
- Логирование в веб-консоль (если включено)




---

`logToWebConsole(timestamp, level, message, data)`

**Назначение:** Логирование в веб-консоль на странице.

**Параметры:**
- `timestamp` (String) - метка времени
- `level` (String) - уровень логирования
- `message` (String) - текстовое сообщение
- `data` (Any) - дополнительные данные или источник сообщения

**Действия:**
- Поиск элемента веб-консоли
- Формирование HTML структуры сообщения
- Добавление сообщения в начало консоли
- Ограничение количества сообщений (макс. 500)
- Экранирование HTML символов

---

`escapeHtml(text)`

**Назначение:** Экранирование HTML символов.

**Параметры:**
- `text` (String) - текст для экранирования

**Возвращает:** Экранированную строку

### Публичное API

`getStatus()`

**Назначение:** Получение текущего состояния клиента.

**Возвращает:** Объект с информацией о состоянии:

```javascript
{
  status: 'connected',           // Текущее состояние
  transportState: 1,            // Состояние транспорта (0-3)
  clientId: 'client_123456789', // ID клиента от сервера
  reconnectAttempts: 0,         // Количество попыток восстановления связи
  config: {...}                 // Текущая конфигурация
}
```

---

`executeTestCommand(command)`

**Назначение:** Ручное выполнение команды (для отладки).

**Параметры:**
- `command` (Object) - объект команды

**Возвращает:** Результат выполнения (`true`/`false`)

**Использование:**
```javascript
window.dashboardCommandClient.executeTestCommand({
  id: 'testElement',
  action: 'add_class',
  class: 'active'
});
```

## Глобальные функции (отладка)

После инициализации клиента создаются глобальные функции для отладки:

`window.connectCommandServer()`
Ручное подключение к серверу команд.

`window.disconnectCommandServer()`
Ручное отключение от сервера команд.

`window.getCommandClientStatus()`
Получение текущего статуса клиента.

## Инициализация

Клиент автоматически инициализируется при событии `DOMContentLoaded`:

```javascript
document.addEventListener('DOMContentLoaded', () => {
  // Получение конфигурации из PHP
  const commandServerConfig = window.DASHBOARD_CONFIG?.commandServer;
  
  // Создание клиента команд
  window.dashboardCommandClient = new DashboardDomCommandClientV4(commandServerConfig);
  
  // Создание глобальных функций для отладки
  // ...
});
```

## Особенности реализации v4.2

### Улучшенная обработка ошибок
- Валидация всех входных параметров
- Защита от некорректных команд
- Подробное логирование ошибок

### Гибкая система логирования
- 4 уровня детализации
- Поддержка веб-консоли и console браузера
- Автоматическая ротация сообщений
- Фильтрация по уровню отладки

### Надежность канала связи
- Экспоненциальная задержка при восстановлении соединения
- Ограничение максимального количества попыток
- Graceful shutdown при ручном отключении
- Периодическая проверка связи с сервером
```
