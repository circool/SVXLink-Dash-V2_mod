# Документация WebSocket клиента v4.2

## Обзор

WebSocket клиент версии 4.2 обеспечивает двустороннюю коммуникацию между браузером и сервером SvxLink Dashboard в реальном времени. Клиент автоматически подключается к WebSocket серверу, обрабатывает команды обновления DOM и поддерживает визуальную индикацию состояния соединения.

## Архитектура

### Основные компоненты

- **DashboardWebSocketClientV4** - основной класс клиента
- **Менеджер соединений** - управление подключением и переподключениями
- **Обработчик DOM-команд** - выполнение команд обновления интерфейса
- **Интерфейс статуса** - кнопка визуальной индикации в навигации
- **Система логирования** - логирование в веб-консоль

### Состояния соединения

- **connected** - успешное подключение к серверу
- **connecting** - процесс подключения
- **reconnecting** - процесс переподключения после разрыва
- **disconnected** - ручное отключение
- **error** - ошибка соединения
- **timeout** - таймаут подключения

## Конфигурация

### Параметры по умолчанию

```javascript
{
  host: window.location.hostname,  // Хост сервера
  port: 8080,                      // Порт WebSocket
  autoConnect: true,               // Автоподключение при загрузке
  reconnectDelay: 3000,            // Задержка переподключения (мс)
  debugLevel: 2,                   // Уровень логирования: 1=ERROR, 2=WARNING, 3=INFO, 4=DEBUG
  debugWebConsole: true,           // Логи в веб-консоль
  debugConsole: false,             // Логи в console браузера
  maxReconnectAttempts: 5,         // Макс. попыток переподключения
  pingInterval: 30000              // Интервал ping (мс)
}
```

### Получение конфигурации

Клиент ожидает конфигурацию в глобальной переменной:
```javascript
window.DASHBOARD_CONFIG = {
  websocket: {
    host: "192.168.1.100",
    port: 8080,
    // ... другие параметры
  }
};
```

## Методы класса

### Инициализация и управление соединением

`constructor(config = {})`

**Назначение:** Создание экземпляра клиента WebSocket.

**Параметры:**
- `config` (Object) - конфигурация клиента

**Действия:**
- Инициализация конфигурации с значениями по умолчанию
- Создание статусной кнопки в навигации
- Автоматическое подключение (если `autoConnect: true`)

---

`init()`

**Назначение:** Инициализация клиента.

**Действия:**
- Создание кнопки статуса WebSocket
- Автоподключение с задержкой 1 секунда
- Логирование информации об инициализации

---

`connect()`

**Назначение:** Установка соединения с WebSocket сервером.

**Действия:**
- Сброс флага ручного отключения
- Закрытие существующего соединения (если есть)
- Создание нового WebSocket соединения
- Установка обработчиков событий
- Настройка таймаута подключения (5 секунд)
- Обновление статуса на "connecting"

**Возвращает:** `true` при успешной попытке подключения, `false` при ошибке

---

`disconnect()`

**Назначение:** Ручное отключение от сервера.

**Действия:**
- Установка флага ручного отключения
- Закрытие WebSocket соединения с кодом 1000
- Очистка таймеров
- Обновление статуса на "disconnected"
- Логирование действия

---

`reconnect()`

**Назначение:** Автоматическое переподключение после разрыва соединения.

**Действия:**
- Проверка на ручное отключение (прерывание)
- Увеличение счетчика попыток
- Расчет экспоненциальной задержки
- Логирование информации о переподключении
- Обновление статуса на "reconnecting"
- Запуск таймера для нового подключения

---

`scheduleReconnect()`

**Назначение:** Планирование следующей попытки переподключения.

**Действия:**
- Проверка максимального количества попыток
- Вызов `reconnect()` или установка статуса "error"

### Обработчики событий WebSocket

`handleOpen(event)`

**Назначение:** Обработка успешного подключения.

**Действия:**
- Логирование успешного подключения
- Сброс счетчика попыток переподключения
- Обновление статуса на "connected"
- Запуск таймера для ping-запросов

---

`handleMessage(event)`

**Назначение:** Обработка входящих сообщений от сервера.

**Обрабатывает:**
- **welcome** - приветственное сообщение с версией и ID клиента
- **pong** - ответ на ping-запросы
- **dom_commands** - команды обновления DOM
- **log_message** - логи с сервера
- **массив команд** - прямая передача команд (для совместимости)

**Действия:**
- Парсинг JSON данных
- Маршрутизация сообщений по типам
- Фильтрация логов по уровню отладки
- Обработка команд DOM через `processCommands()`

---

`handleClose(event)`

**Назначение:** Обработка закрытия соединения.

**Действия:**
- Логирование кода и причины закрытия
- Очистка таймеров
- Проверка на ручное отключение
- Запуск переподключения (если не ручное отключение)

---

`handleError(error)`

**Назначение:** Обработка ошибок соединения.

**Действия:**
- Логирование ошибки
- Обновление статуса на "error"

### Обработка DOM команд

`processCommands(commands, chunkNum, totalChunks)`

**Назначение:** Основной метод обработки пакетов команд.

**Параметры:**
- `commands` (Array) - массив команд для выполнения
- `chunkNum` (Number) - номер текущего чанка (опционально)
- `totalChunks` (Number) - общее количество чанков (опционально)

**Действия:**
- Валидация входных данных
- Логирование информации о чанках
- Последовательное выполнение команд через `executeAction()`
- Подсчет успешных и неудачных операций
- Логирование результатов выполнения

---

`executeAction(cmd)`

**Назначение:** Выполнение одиночной команды.

**Параметры:**
- `cmd` (Object) - объект команды

**Действия:**
- Валидация обязательных полей
- Маршрутизация по типу действия
- Вызов соответствующего метода обработки
- Возврат результата выполнения

**Возвращает:** `true` при успешном выполнении, `false` при ошибке

### Основные операции DOM

`handleAddClass(cmd)`

**Назначение:** Добавление класса(ов) к элементу.

**Параметры команды:**
- `id` (String) - ID целевого элемента
- `class` (String) - класс или список классов через запятую

**Действия:**
- Поиск элемента по ID
- Добавление одного или нескольких классов
- Логирование операции

---

`handleRemoveClass(cmd)`

**Назначение:** Удаление класса(ов) из элемента.

**Параметры команды:**
- `id` (String) - ID целевого элемента
- `class` (String) - класс или список классов через запятую

**Действия:**
- Поиск элемента по ID
- Удаление одного или нескольких классов
- Логирование операции

---

`handleReplaceClass(cmd)`

**Назначение:** Замена одного класса на другой.

**Параметры команды:**
- `id` (String) - ID целевого элемента
- `old_class` (String) - старый класс для замены
- `new_class` (String) - новый класс

**Действия:**
- Поиск элемента по ID
- Проверка наличия старого класса
- Замена старого класса на новый
- Логирование операции

---

`handleSetContent(cmd)`

**Назначение:** Полная замена содержимого элемента.

**Параметры команды:**
- `id` (String) - ID целевого элемента
- `payload` (String) - новое HTML содержимое

**Действия:**
- Поиск элемента по ID
- Установка нового содержимого через `innerHTML`
- Логирование операции (обрезание длинного контента)

---

`handleReplaceContent(cmd)`

**Назначение:** Частичная замена содержимого элемента.

**Параметры команды:**
- `id` (String) - ID целевого элемента
- `payload` (Array) - массив из трех элементов:
  + `beginCond` - открывающая последовательность для поиска
  + `endCond` - закрывающая последовательность для поиска
  + `newContent` - новое содержимое для вставки

**Действия:**
- Поиск элемента по ID
- Поиск позиций открывающей и закрывающей последовательностей
- Замена содержимого между последовательностями
- Логирование операции

---

`handleSetContentByClass(cmd)`

**Назначение:** Установка содержимого для элементов по классу.

**Параметры команды:**
- `targetClass` (String) - класс для поиска элементов
- `payload` (String) - новое HTML содержимое
- `multipleElements` (Boolean) - обработка всех элементов или одного (по умолчанию false)
- `elementIndex` (Number) - индекс элемента при `multipleElements: false`

**Действия:**
- Поиск всех элементов с указанным классом
- Определение режима обработки (один/все элементы)
- Установка содержимого для выбранных элементов
- Логирование количества обработанных элементов

---

`handleRemoveElement(cmd)`

**Назначение:** Удаление элемента из DOM.

**Параметры команды:**
- `id` (String) - ID элемента для удаления

**Действия:**
- Поиск элемента по ID
- Вызов метода `remove()`
- Логирование операции

### Родительские операции

`handleParentClass(cmd, operation)`

**Назначение:** Добавление или удаление класса у родительского элемента.

**Параметры команды:**
- `id` (String) - ID дочернего элемента
- `class` (String) - класс или список классов через запятую
- `action` (String) - тип операции: `add_parent_class` или `remove_parent_class`

**Действия:**
- Поиск родительского элемента через кэш
- Добавление или удаление классов
- Логирование операции

---

`handleReplaceParentContent(cmd)`
**Назначение:** Частичная замена содержимого родительского элемента.

**Параметры команды:**
- `id` (String) - ID дочернего элемента
- `payload` (Array) - массив из трех элементов (аналогично `handleReplaceContent`)

**Действия:**
- Поиск родительского элемента через кэш
- Поиск и замена содержимого между последовательностями
- Логирование операции

### Операции над дочерними элементами

`addChild(cmd)`

**Назначение:** Добавление дочернего элемента.

**Параметры команды:**
- `target` (String) - ID родительского элемента
- `payload` (String) - HTML содержимое нового элемента
- `type` (String) - тип элемента (по умолчанию 'div')
- `id` (String) - ID нового элемента (опционально)
- `class` (String) - класс нового элемента (опционально)
- `style` (String) - inline стили (опционально)
- `title` (String) - title атрибут (опционально)

**Действия:**
- Поиск родительского элемента
- Проверка существования элемента с таким ID
- Создание нового элемента с указанными параметрами
- Добавление элемента к родителю
- Логирование операции

---

`removeChild(cmd)`

**Назначение:** Удаление дочерних элементов с фильтрацией.

**Параметры команды:**
- `id` (String) - ID родительского элемента
- `ignoreClass` (String) - классы, которые НЕ должны удаляться (через запятую)

**Действия:**
- Поиск родительского элемента
- Получение всех дочерних элементов
- Удаление элементов, у которых нет указанных в `ignoreClass` классов
- Логирование операции

---

`replaceChildClasses(cmd)`

**Назначение:** Замена классов у всех дочерних элементов первого уровня.

**Параметры команды:**
- `id` (String) - ID родительского элемента
- `oldClass` (String) - старые классы для замены (через запятую)
- `class` (String) - новые классы для установки (через запятую)

**Действия:**
- Поиск родительского элемента
- Получение всех дочерних элементов первого уровня
- Проверка наличия ВСЕХ старых классов у каждого элемента
- Замена старых классов на новые (для соответствующих элементов)
- Логирование количества измененных элементов

### Специальные операции

`handleSetCheckboxState(cmd)`

**Назначение:** Синхронизация состояния чекбокса.

**Параметры команды:**
- `id` (String) - ID элемента чекбокса
- `state` (String) - состояние: 'on' или 'off'

**Действия:**
- Поиск элемента чекбокса
- Преобразование строкового состояния в boolean
- Установка свойства `checked`
- Логирование операции (в режиме отладки)

### Вспомогательные методы

#### Управление элементами DOM

`getElement(id)`


**Назначение:** Поиск элемента по ID.

**Параметры:**
- `id` (String) - ID элемента

**Возвращает:** DOM элемент или `null`

**Действия:**
- Поиск через `document.getElementById()`
- Логирование предупреждения при отсутствии элемента (уровень 2+)

`getParentElement(childId)`

**Назначение:** Поиск родительского элемента с кэшированием.

**Параметры:**
- `childId` (String) - ID дочернего элемента

**Возвращает:** Родительский DOM элемент или `null`

**Действия:**
- Проверка кэша родительских элементов
- Поиск дочернего элемента
- Получение родительского элемента через `parentElement`
- Сохранение в кэш для последующего использования

`clearParentCache(childId)`

**Назначение:** Очистка кэша родительских элементов.

**Параметры:**
- `childId` (String) - ID для очистки конкретной записи (опционально)

**Действия:**
- Удаление записи из кэша или полная очистка

#### Управление таймерами

`startPingTimer()`

**Назначение:** Запуск таймера для ping-запросов.

**Действия:**
- Очистка существующего таймера
- Установка интервального таймера
- Отправка ping-сообщений на сервер
- Логирование в режиме отладки

`clearTimers()`

**Назначение:** Очистка всех активных таймеров.

**Действия:**
- Остановка ping-таймера
- Остановка таймера переподключения

#### Управление статусом

`updateStatus(status, message)`

**Назначение:** Обновление визуального состояния соединения.

**Параметры:**
- `status` (String) - новое состояние соединения
- `message` (String) - сообщение для отображения

**Действия:**
- Обновление внутреннего состояния
- Логирование изменения статуса
- Обновление текста и стилей статусной кнопки
- Установка соответствующего tooltip

`createStatusButton()`
**Назначение:** Создание кнопки статуса в навигации.

**Действия:**
- Удаление старой кнопки (если есть)
- Поиск навигационной панели
- Создание новой кнопки с обработчиком клика
- Добавление кнопки в DOM
- Логирование создания

`handleStatusButton()`
**Назначение:** Обработка клика по статусной кнопке.

**Действия в зависимости от состояния:**
- **connected** - ручное отключение (`disconnect()`)
- **disconnected/error/timeout** - перезагрузка страницы
- **connecting/reconnecting** - игнорирование клика

`startPageReload()`
**Назначение:** Инициирование перезагрузки страницы.

**Действия:**
- Логирование начала перезагрузки
- Обновление текста статусной кнопки
- Перезагрузка страницы через 300 мс

#### Логирование

`log(level, message, data)`
**Назначение:** Многоуровневое логирование.

**Параметры:**
- `level` (String|Number) - уровень логирования
- `message` (String) - текстовое сообщение
- `data` (Any) - дополнительные данные (опционально)

**Уровни логирования:**
1. **ERROR** - критические ошибки
2. **WARNING** - предупреждения
3. **INFO** - информационные сообщения (по умолчанию)
4. **DEBUG** - детальная отладочная информация

**Действия:**
- Проверка уровня отладки конфигурации
- Логирование в консоль браузера (если включено)
- Логирование в веб-консоль (если включено)

`logToWebConsole(timestamp, level, message, data)`
**Назначение:** Логирование в веб-консоль на странице.

**Параметры:**
- `timestamp` (String) - метка времени
- `level` (String) - уровень логирования
- `message` (String) - текстовое сообщение
- `data` (Any) - дополнительные данные или источник сообщения

**Действия:**
- Поиск элемента веб-консоли
- Формирование HTML структуры сообщения
- Добавление сообщения в начало консоли
- Ограничение количества сообщений (макс. 500)
- Экранирование HTML символов

`escapeHtml(text)`
**Назначение:** Экранирование HTML символов.

**Параметры:**
- `text` (String) - текст для экранирования

**Возвращает:** Экранированную строку

### Публичное API

`getStatus()`
**Назначение:** Получение текущего состояния клиента.

**Возвращает:** Объект с информацией о состоянии:

```javascript
{
  status: 'connected',           // Текущее состояние
  wsState: 1,                    // Состояние WebSocket (0-3)
  clientId: 'client_123456789',  // ID клиента от сервера
  reconnectAttempts: 0,          // Количество попыток переподключения
  parentCacheSize: 5,            // Размер кэша родительских элементов
  config: {...}                  // Текущая конфигурация
}
```

`executeTestCommand(command)`
**Назначение:** Ручное выполнение команды (для отладки).

**Параметры:**
- `command` (Object) - объект команды

**Возвращает:** Результат выполнения (`true`/`false`)

**Использование:**
```javascript
window.dashboardWSClient.executeTestCommand({
  id: 'testElement',
  action: 'add_class',
  class: 'active'
});
```

## Глобальные функции (отладка)

После инициализации клиента создаются глобальные функции для отладки:

`window.connectWebSocket()`
Ручное подключение к серверу.

`window.disconnectWebSocket()`
Ручное отключение от сервера.

`window.getWebSocketStatus()`
Получение текущего статуса клиента.

`window.sendTestCommand(command)`
Выполнение тестовой команды.

`window.testCommands`
Набор готовых тестовых команд:
- `addClass(id, className)` - добавление класса
- `removeClass(id, className)` - удаление класса
- `setContent(id, content)` - установка содержимого
- `addParentClass(id, className)` - добавление класса родителю
- `removeParentClass(id, className)` - удаление класса у родителя

## Инициализация

Клиент автоматически инициализируется при событии `DOMContentLoaded`:

```javascript
document.addEventListener('DOMContentLoaded', () => {
  // Получение конфигурации из PHP
  const wsConfig = window.DASHBOARD_CONFIG?.websocket;
  
  // Создание клиента
  window.dashboardWSClient = new DashboardWebSocketClientV4(wsConfig);
  
  // Создание глобальных функций для отладки
  // ...
});
```

## Особенности реализации v4.2

### Кэширование родительских элементов
- Автоматическое кэширование при первом обращении
- Увеличение производительности при частых операциях с родителями
- Ручная очистка через `clearParentCache()`

### Улучшенная обработка ошибок
- Валидация всех входных параметров
- Защита от некорректных команд
- Подробное логирование ошибок

### Гибкая система логирования
- 4 уровня детализации
- Поддержка веб-консоли и console браузера
- Автоматическая ротация сообщений
- Фильтрация по уровню отладки

### Надежность соединения
- Экспоненциальная задержка переподключений
- Ограничение максимального количества попыток
- Graceful shutdown при ручном отключении
- Ping-pong для поддержания соединения