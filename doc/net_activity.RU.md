# Техническое описание модуля net_activity.php

## Общая информация

**Файл:** `/include/net_activity.php`  
**Версия:** 0.4.6  
**Назначение:** Отображение и фильтрация сетевой активности (Frn, Reflector, EchoLink)  
**Зависимости:** logTailer.php, parseXmlTags.php, getLineTime.php, getTranslation.php, formatDuration.php

---

## 1. Режимы работы

### 1.1 Нормальный режим (в составе index.php)
```php
if (!isset($_GET['ajax']))
```
- Включается непосредственно в index.php
- Отображает полный блок с фильтрами и таблицей
- Сохраняет GET-параметры фильтрации в сессию

### 1.2 AJAX-режим (периодические обновления)
```php
if (isset($_GET['ajax']) && $_GET['ajax'] == 1)
```
- Вызывается через block_updater.js
- Возвращает только HTML таблицы
- Поддерживает GET и POST методы

---

## 2. Обработка фильтрации

### 2.1 Механизм хранения настроек

**Сессионные переменные:**
```php
$_SESSION['net_filter']      // 'ON' или 'OFF' - показывать всё или фильтровать
$_SESSION['net_filter_max']  // float, порог отсечения (0.5-5.0 сек)
```

**Сценарии записи:**

1. **При загрузке index.php:**
```php
if (isset($_GET['filter_activity'])) {
    $_SESSION['net_filter'] = $_GET['filter_activity'];
}
```
GET-параметры из URL сохраняются в сессию при полной загрузке страницы.

2. **При изменении фильтра пользователем:**
```javascript
fetch('/include/net_activity.php?ajax=1', {
    method: 'POST',
    body: JSON.stringify({
        filter_activity: 'ON/OFF',
        filter_activity_max: 1.5
    })
})
```
POST-запрос сохраняет настройки в сессию без перезагрузки страницы.

3. **При AJAX-обновлении:**
```php
// GET-запрос от block_updater.js
echo getNetActivityTable();  // читает настройки из сессии
```

### 2.2 Применение фильтра

В функции `getNetActivityActions()`:
```php
$min_duration = 1;  // базовое значение
if (isset($_SESSION['net_filter']) && $_SESSION['net_filter'] === 'OFF') {
    $min_duration = 0;  // показать всё
} elseif (isset($_SESSION['net_filter_max'])) {
    $min_duration = $_SESSION['net_filter_max'];  // порог отсечения
}
```

Фильтр применяется в двух местах:
```php
// При завершении передачи
if ($stop - $row['start'] > $min_duration) {
    // сохраняем только передачи длиннее порога
}

// Для незавершенных передач
if ($lastMsgDuration > $min_duration) {
    // показываем только если уже длиннее порога
}
```

### 2.3 Ограничения фильтра
- HTML-ограничение: `min="0.5" max="5" step="0.5"`
- Сессия не ограничивает значения (доверие к HTML)
- При `filter_activity = OFF` (`min_duration = 0`) показываются **все** передачи, включая керчанки

---

## 3. Алгоритм сбора сетевой активности

### 3.1 Условия отбора строк лога
```php
$or_condition = [
    'Turning the transmitter',  // включение/выключение передатчика
    'voice started',           // начало голосовой активности Frn
    'Talker start',           // начало активности в рефлекторе
    'Talker stop',           // окончание активности в рефлекторе
    'message received from'  // сообщения EchoLink (chat/info)
];
```

### 3.2 Размер выборки
**Текущая реализация:**
```php
$log_actions = getLogTailFiltered(
    NET_ACTIVITY_LIMIT * 15,  // жестко заданный множитель
    null, 
    $or_condition, 
    $actualLogSize
);
```
**Проблема:** Не зависит от `$min_duration`. При высоких порогах фильтрации выборка может не содержать достаточного количества событий.

**Рекомендация:** Реализовать динамический множитель, зависящий от `$min_duration`.

---

## 4. Парсинг источников активности

### 4.1 Frn (Free Radio Network)
**Триггер:** строка содержит `voice started`  
**Флаг:** `$source = "Frn"`  
**Парсинг:** `parseXmlTags($parent)`  
**Формат вывода:**
```
Frn: <b>{ON}</b>, {CT} ({BC} / {DS})
```
**При неудаче:** `$source = ''`

### 4.2 Reflector
**Триггер:** строка содержит `Talker start`  
**Флаг:** `$source = "Reflector"`  
**Парсинг:** regexp `/^(.+?): (\S+): Talker start on TG #(\d*): (\S+)$/`  
**Формат вывода:**
```
{имя_логики}: <b>{позывной} in TG: {номер}</b>
```
**При неудаче:** `$source = ''`

### 4.3 EchoLinkConference
**Триггер:** строка содержит `message received from`  
**Флаг:** `$source = "EchoLinkConference"`  
**Парсинг:** regexp `/received from (.+) ---$/`  
**Формат вывода:**
```
EchoLink Conference <b>{имя_конференции}</b>
```
**При неудаче:** `$source = ''`

### 4.4 Важное ограничение по времени
```php
if ($diff_sec > ACTION_LIFETIME) {  // ACTION_LIFETIME = 1
    $parent = '';
    $source = '';  // сброс, если событие старше 1 секунды
}
```
Только события, произошедшие не более чем за 1 секунду до включения передатчика, считаются вызвавшими эту передачу.

---

## 5. Структура данных события

```php
$row = [
    'start'       => int,    // timestamp начала передачи
    'date'        => string, // дата в формате 'd M Y'
    'time'        => string, // время в формате 'H:i:s'
    'source'      => string, // HTML-строка с описанием источника
    'destination' => string, // не используется
    'duration'    => int     // длительность в секундах
];
```

### 5.1 Очистка флагов
```php
if ($source === 'Frn' || $source === 'Reflector' || $source === 'EchoLinkConference') {
    $row['source'] = '';  // нераспознанный источник не сохраняется
}
```
Это гарантирует, что в таблицу попадают только успешно распарсенные события.

---

## 6. Жизненный цикл события

1. **Обнаружение причины** (`voice started`/`Talker start`/`message received from`)
   - Запоминается строка в `$parent`
   - Устанавливается флаг `$source`

2. **Включение передатчика** (`Turning the transmitter ON`)
   - Проверка `!empty($parent)`
   - Проверка `$diff_sec <= ACTION_LIFETIME`
   - Парсинг источника
   - Создание записи с `$row['start']`

3. **Активная передача**
   - `$row['start']` > 0
   - Новые события-причины игнорируются

4. **Выключение передатчика** (`Turning the transmitter OFF`)
   - Расчет длительности: `$stop - $row['start']`
   - Применение фильтра `$min_duration`
   - Сохранение в `$result[]`
   - Сброс всех переменных

5. **Незавершенная передача** (конец цикла обработки)
   - Если `$row['start']` > 0 и передатчик все еще включен
   - Расчет текущей длительности: `time() - $row['start']`
   - Применение фильтра `$min_duration`
   - Сохранение в `$result[]`

---

## 7. Формирование вывода

### 7.1 Сортировка
```php
array_slice(array_reverse($result), 0, NET_ACTIVITY_LIMIT)
```
- События сортируются от новых к старым
- Ограничиваются константой `NET_ACTIVITY_LIMIT` (из settings.php)

### 7.2 Временная зона
```php
if (isset($_SESSION['TIMEZONE'])) {
    date_default_timezone_set($_SESSION['TIMEZONE']);
}
```
Временная зона устанавливается в `init.php` и хранится в сессии.

---

## 8. Потенциальные проблемы и рекомендации

### 8.1 Размер выборки
**Текущее состояние:** Жесткий множитель 15 не зависит от порога фильтрации.  
**Рекомендация:** Реализовать динамический расчет:
```php
$multiplier = $min_duration == 0 ? 50 : 15 * (1 + $min_duration * 0.5);
$log_limit = (int)(NET_ACTIVITY_LIMIT * min(100, $multiplier));
```

### 8.2 Валидация сессионных данных
**Текущее состояние:** Нет ограничений на значения в сессии.  
**Рекомендация:** Добавить нормализацию при чтении:
```php
$min_duration = $_SESSION['net_filter_max'] ?? 1;
$min_duration = max(0.5, min(30, $min_duration));  // 0.5-30 сек
if ($_SESSION['net_filter'] === 'OFF') $min_duration = 0;
```

### 8.3 Обработка ошибок парсинга
**Текущее состояние:** Флаги сбрасываются в пустую строку.  
**Рекомендация:** Логировать частоту неудачных парсингов для отладки:
```php
if ($source === 'EchoLinkConference' && !preg_match(...)) {
    error_log("Failed to parse EchoLink conference from: " . $parent);
    $source = '';
}
```

### 8.4 Производительность
**Текущее состояние:** При каждом AJAX-обновлении читается лог.  
**Рекомендация:** Кэшировать результаты парсинга на короткое время (1-2 сек).

---

## 9. Ключевые константы

| Константа | Значение | Назначение |
|-----------|---------|------------|
| `ACTION_LIFETIME` | 1 | Макс. задержка между событием и включением (сек) |
| `NET_ACTIVITY_LIMIT` | из settings | Макс. количество отображаемых записей |
| `min="0.5" max="5"` | HTML | Границы ползунка фильтра |

---

## 10. Схема данных в сессии

```php
$_SESSION['status'] = [
    'service' => [
        'log_line_count' => int,  // размер лога для поиска
        // ...
    ]
    // ...
];

$_SESSION['net_filter'] = 'ON'|'OFF';
$_SESSION['net_filter_max'] = float;  // 0.5-5.0
$_SESSION['TIMEZONE'] = string;  // временная зона
```

---

## Заключение

Модуль net_activity.php реализует сложную логику сопоставления включений передатчика с сетевыми событиями, используя временные метки из лога SvxLink. Фильтрация по длительности реализована через сессионные переменные, что позволяет AJAX-обновлениям работать без модификации block_updater.js.

Основной недостаток текущей реализации - статический размер выборки лога, не учитывающий порог фильтрации. Рекомендуется внедрить динамический расчет множителя на основе экспоненциальной зависимости.