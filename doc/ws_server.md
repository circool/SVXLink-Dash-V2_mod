# Документация WebSocket сервера v4.17

## Обзор

Stateful WebSocket сервер версии 4.17 обеспечивает обработку событий SvxLink в реальном времени, мониторинг лог-файлов, управление состоянием и рассылку DOM-команд всем подключенным клиентам. Сервер загружает начальное состояние из PHP endpoint, восстанавливает таймеры и связи, а также обеспечивает автоматическое управление подключениями.

## Архитектура

### Основные компоненты

- **StatefulWebSocketServerV4** - основной класс сервера
- **StateManager** - менеджер таймеров и временных состояний
- **CommandParser** - парсер логов SvxLink с генерацией DOM-команд
- **ConnectionHandler** - обработчик связей между компонентами
- **Log Monitor** - мониторинг лог-файла SvxLink через `tail -F`

### Состояния сервера

- **running** - сервер запущен и готов к подключениям
- **monitoring** - активен мониторинг лог-файла
- **idle** - нет подключенных клиентов, ожидание отключения
- **shutting_down** - процесс корректного завершения
- **error** - критическая ошибка сервера

## Конфигурация

### Константы и настройки

```javascript
const CONFIG = {
    version: '0.4.17',
    ws: {
        host: '0.0.0.0',           // Хост для прослушивания
        port: 8080,                // Порт WebSocket
        clientTimeout: 15000       // Таймаут отключения при отсутствии клиентов (мс)
    },
    log: {
        path: '/var/log/svxlink',  // Путь к лог-файлу SvxLink
        bufferTimeout: 3,          // Таймаут буферизации логов (сек)
        maxBufferSize: 50          // Максимальный размер буфера строк
    },
    duration: {
        updateInterval: 1000       // Интервал обновления таймеров (мс)
    },
    php: {
        stateEndpoint: 'http://localhost/ws_state.php', // PHP endpoint для начального состояния
        timeout: 3000              // Таймаут запроса к PHP (мс)
    }
};
```

### Уровни логирования

Сервер поддерживает 4 уровня логирования (настраивается через переменную окружения `DEBUG_LEVEL`):

1. **ERROR** - критичиеские ошибки (уровень 1)
2. **WARNING** - предупреждения (уровень 2)
3. **INFO** - информационные сообщения (уровень 3)
4. **DEBUG** - детальная отладочная информация (уровень 4)

## Классы сервера

### StateManager

Менеджер временных состояний и таймеров.

#### Методы

`formatDuration(milliseconds)`

**Назначение:** Форматирование длительности в читаемый вид.

**Возвращает:** Форматированную строку:
- `< 60 сек`: "N s"
- `< 1 часа`: "MM:SS"
- `≥ 1 часа`: "HH:MM:SS"

---

`startTimer(key, metadata = {})`

**Назначение:** Запуск нового таймера.

**Параметры:**
- `key` (String) - уникальный ключ таймера
- `metadata` (Object) - метаданные таймера:
  - `elementId` - ID DOM элемента для обновления
  - `replaceStart` - начальный маркер для замены
  - `replaceEnd` - конечный маркер для замены
  - Дополнительные пользовательские поля

**Действия:**
- Проверка существующих таймеров с тем же `elementId`
- Удаление конфликтующих таймеров
- Регистрация нового таймера в коллекции

**Возвращает:** Время старта таймера (timestamp)

---

`stopTimer(key)`

**Назначение:** Остановка и удаление таймера.

**Параметры:**
- `key` (String) - ключ таймера для остановки

**Возвращает:** `true` если таймер существовал, `false` если нет

---

`setTimerStart(key, startTimestamp)`

**Назначение:** Установка времени начала существующего таймера.

**Параметры:**
- `key` (String) - ключ таймера
- `startTimestamp` (Number) - время старта (timestamp)

**Возвращает:** `true` при успехе, `false` если таймер не найден

---

`getTimerUpdates()`

**Назначение:** Получение обновлений для активных таймеров.

**Возвращает:** Массив объектов обновлений:
```javascript
[
    {
        key: 'timer_key',
        durationMs: 15000,
        metadata: { ... }
    }
]
```

---

`getStats()`

**Назначение:** Получение статистики менеджера.

**Возвращает:** Объект статистики:
```javascript
{
    activeTimers: 5
}
```

### ConnectionHandler

Обработчик связей между компонентами системы (логики, модули, линки, узлы).

#### Методы

`add(source, target)`

**Назначение:** Добавление связи между компонентами.

**Параметры:**
- `source` (String) - источник связи
- `target` (String) - цель связи

**Действия:**
- Создание коллекции для источника (если отсутствует)
- Добавление цели в коллекцию источника

---

`remove(source, target)`

**Назначение:** Удаление связи между компонентами.

**Параметры:**
- `source` (String) - источник связи
- `target` (String) - цель связи

**Действия:**
- Удаление цели из коллекции источника
- Удаление пустой коллекции источника

---

`getAllFrom(source)`

**Назначение:** Получение всех целей для источника.

**Параметры:**
- `source` (String) - источник связи

**Возвращает:** Массив целей или пустой массив

---

`getAllTo(target)`

**Назначение:** Получение всех источников для цели.

**Параметры:**
- `target` (String) - цель связи

**Возвращает:** Массив источников

---

`initFromData(data, sourceKey, targetKey)`
**Назначение:** Инициализация связей из данных PHP.

**Параметры:**
- `data` (Object) - данные связей в формате `{source: [targets]}`
- `sourceKey` (String) - описание типа источника (для логирования)
- `targetKey` (String) - описание типа цели (для логирования)

### CommandParser

Парсер строк лога SvxLink с генерацией DOM-команд. Поддерживает два режима работы: обычный и пакетный (для EchoLink/Frn сообщений).

#### Параметры конструктора

- `stateManager` (StateManager) - экземпляр менеджера состояний

#### Поддерживаемые паттерны

Сервер распознает 40+ паттернов логов SvxLink, включая:

**Сервис:**
- Запуск сервиса SvxLink
- Остановка сервиса (SIGTERM)

**Логики:**
- Старт логики
- Загрузка модулей
- Загрузка устройств RX/TX

**Устройства:**
- Включение/выключение передатчика (Transmitter ON/OFF)
- Открытие/закрытие шумоподавителя (Squelch OPEN/CLOSED)

**Рефлекторы:**
- Подключение/отключение от рефлектора
- Подключенные узлы
- Вход/выход узлов
- Выбор разговорных групп

**Модули:**
- Активация/деактивация модулей
- Состояния EchoLink/Frn
- Сообщения конференций

**Линки:**
- Активация/деактивация связей

#### Методы

`parse(line)`

**Назначение:** Основной метод парсинга строки лога.

**Параметры:**
- `line` (String) - строка лога для парсинга

**Возвращает:** Объект результата или `null`:
```javascript
{
    commands: [],          // Массив DOM-команд
    raw: "original_line",  // Оригинальная строка
    timestamp: "timestamp" // Временная метка
}
```

**Особенности:**
- Поддерживает пакетный режим для EchoLink сообщений
- Автоматически переключается между режимами

---

`timerUpdatesToCommands(timerUpdates)`

**Назначение:** Преобразование обновлений таймеров в DOM-команды.

**Параметры:**
- `timerUpdates` (Array) - массив обновлений от StateManager

**Возвращает:** Массив DOM-команд для обновления времени

---

`initFromWsData(wsData)`

**Назначение:** Инициализация парсера из данных PHP.

**Параметры:**
- `wsData` (Object) - данные состояния из PHP:
  - `module_logic` - связи модуль-логика
  - `link_logic` - связи линк-логика

#### Пакетный режим (EchoLink)

Команды:
- `EchoLink: --- EchoLink chat message received from ... ---` - начало пакета
- `Trailing chat data:` - конец пакета
- Строки вида `->R2ADU-L Moscow 145.4625 #88.5` или `R2ADU>test` - данные пакета

Обработка:
1. Включение режима ожидания позывного
2. Обработка строк с `->` или `>`
3. Форматирование HTML с тегами `<b>`
4. Отправка через команду `set_content_by_class`

### StatefulWebSocketServerV4

Основной класс WebSocket сервера.

#### Методы

##### Инициализация и управление

`constructor(config = {})`

**Назначение:** Создание экземпляра сервера.

**Параметры:**
- `config` (Object) - конфигурация сервера (объединяется с CONFIG)

**Инициализирует:**
- StateManager, CommandParser, ConnectionHandler
- Коллекции клиентов и состояния
- Статистику сервера

---

`async start()`

**Назначение:** Запуск WebSocket сервера.

**Действия:**
- Проверка существования лог-файла
- Запуск WebSocket сервера
- Настройка таймеров
- Обработка сигналов ОС

##### Управление состоянием

`async loadWsState()`
**Назначение:** Загрузка начального состояния из PHP endpoint.

**Процесс:**
1. HTTP запрос к `CONFIG.php.stateEndpoint`
2. Парсинг JSON ответа
3. Распределение данных по компонентам:
   - `devices` - устройства (RX/TX)
   - `modules` - модули
   - `links` - линки
   - `nodes` - узлы
   - `module_logic` - связи модуль-логика
   - `link_logic` - связи линк-логика
   - `logics` - логики
   - `service` - сервис SvxLink

**Обработка ошибок:**
- Таймаут 3 секунды
- Обработка пустых ответов
- Восстановление пустого состояния при ошибках

---

`restoreFromWsState()`

**Назначение:** Восстановление состояния из загруженных данных.

**Восстанавливает:**
1. Связи через CommandParser
2. Таймеры логик
3. Таймеры устройств (RX/TX)
4. Таймеры модулей
5. Таймеры линков
6. Таймеры узлов
7. Таймер сервиса

**Логирование:** Подсчет восстановленных элементов

##### Управление клиентами

`async handleClientConnection(ws, req)`

**Назначение:** Обработка нового подключения клиента.

**Процесс:**
1. Генерация уникального clientId
2. Регистрация клиента в коллекции
3. Отправка приветственного сообщения
4. Загрузка состояния (если первый клиент)
5. Отправка начальных команд
6. Запуск мониторинга (если первый клиент)

**Формат приветствия:**
```javascript
{
    type: 'welcome',
    version: '0.4.17',
    clientId: 'client_123456789',
    serverTime: 1673789200000,
    message: 'Server WebSocket v0.4.15',
    system: 'dom_commands_v4_state',
    initialState: true
}
```

---

`sendInitialCommands(ws)`

**Назначение:** Отправка начального состояния новому клиенту.

**Отправляет:**
- Состояния устройств (RX/TX) с длительностями
- Состояние сервиса SvxLink
- Активные таймеры

---

`handleClientDisconnect(clientId)`

**Назначение:** Обработка отключения клиента.

**Действия:**
- Удаление клиента из коллекции
- Остановка мониторинга при отсутствии клиентов
- Запуск таймера отключения

---

`broadcast(message)`

**Назначение:** Рассылка сообщения всем подключенным клиентам.

**Параметры:**
- `message` (Object) - сообщение для рассылки

**Возвращает:** Количество успешно отправленных сообщений

**Форматы сообщений:**
```javascript
// DOM команды
{
    type: 'dom_commands',
    commands: [...],
    timestamp: 1673789200000,
    total: 15,
    chunk: 1,
    chunks: 2
}

// Логи
{
    type: 'log_message',
    level: 'INFO',
    message: 'Текст сообщения',
    timestamp: '2026-01-16T10:30:00.000Z',
    source: 'WS Server v4'
}
```

##### Мониторинг логов

`startLogMonitoring()`

**Назначение:** Запуск мониторинга лог-файла SvxLink.

**Использует:** `tail -F -n 0 /var/log/svxlink`

**Особенности:**
- Буферизация строк (50 строк, 3 сек)
- Автоматический перезапуск при сбое
- Остановка при отсутствии клиентов

---

`stopLogMonitoring()`

**Назначение:** Остановка мониторинга лог-файла.

**Действия:** Завершение процесса tail с SIGTERM

---

`processLogBuffer(buffer)`

**Назначение:** Обработка буферизированных строк лога.

**Процесс:**
1. Парсинг каждой строки через CommandParser
2. Сбор всех DOM-команд
3. Разделение на чанки по 10 команд
4. Рассылка всем клиентам

**Оптимизация:**
- Лимит обработки: `maxBufferSize` строк
- Чанкинг для больших пакетов
- Подсчет статистики

##### Управление временем

`startDurationTimer()`

**Назначение:** Запуск периодического обновления таймеров.

**Интервал:** `CONFIG.duration.updateInterval` (1000 мс)

**Процесс:**
1. Получение обновлений от StateManager
2. Преобразование в DOM-команды
3. Рассылка клиентам

---

`stopDurationTimer()`

**Назначение:** Остановка таймера обновлений.

##### Управление завершением

`startShutdownTimer()`

**Назначение:** Запуск таймера автоотключения при отсутствии клиентов.

**Таймаут:** `CONFIG.ws.clientTimeout` (15000 мс)

---

`clearShutdownTimer()`

**Назначение:** Сброс таймера автоотключения.

---

`gracefulShutdown()`

**Назначение:** Корректное завершение работы сервера.

**Процесс:**
1. Остановка всех таймеров
2. Остановка мониторинга логов
3. Закрытие соединений с клиентами (код 1000)
4. Закрытие WebSocket сервера
5. Вывод статистики
6. Выход из процесса

##### Статистика

`getStats()`

**Назначение:** Получение статистики сервера.

**Возвращает:**
```javascript
{
    version: '0.4.17',
    uptime: 3600,                     // Время работы (сек)
    clients: 3,                       // Подключенных клиентов
    monitoring: true,                 // Активен мониторинг
    durationTimerActive: true,        // Активен таймер времени
    wsState: {
        devices: 5,                   // Устройств в состоянии
        modules: 3,                   // Модулей в состоянии
        links: 2,                     // Линков в состоянии
        nodes: 10,                    // Узлов в состоянии
        connections: 15               // Связей в ConnectionHandler
    },
    serverStats: {
        startedAt: 1673789200000,     // Время старта
        clientsConnected: 10,         // Всего подключений
        clientsDisconnected: 7,       // Всего отключений
        messagesSent: 1500,           // Отправленных сообщений
        errors: 2,                    // Ошибок
        eventsProcessed: 300,         // Обработанных событий
        commandsGenerated: 1200,      // Сгенерированных команд
        stateLoads: 5,                // Загрузок состояния
        stateLoadErrors: 1            // Ошибок загрузки состояния
    },
    stateStats: {
        activeTimers: 8               // Активных таймеров
    }
}
```

## Форматы сообщений

### Входящие сообщения (от клиента)

`ping`
```javascript
{
    type: 'ping'
}
```

### Исходящие сообщения (к клиенту)

`welcome`
```javascript
{
    type: 'welcome',
    version: '0.4.17',
    clientId: 'client_123456789',
    serverTime: 1673789200000,
    message: 'Server WebSocket v0.4.17',
    system: 'dom_commands_v4_state',
    initialState: true
}
```

`pong`
```javascript
{
    type: 'pong',
    timestamp: 1673789200000
}
```

`dom_commands`
```javascript
{
    type: 'dom_commands',
    commands: [
        {
            id: 'element_id',
            action: 'add_class',
            class: 'active-mode-cell'
        }
    ],
    timestamp: 1673789200000,
    total: 15,        // Общее количество команд (опционально)
    chunk: 1,         // Номер текущего чанка (опционально)
    chunks: 2,        // Всего чанков (опционально)
    subtype: 'initial_state' // Тип пакета (опционально)
}
```

`log_message`
```javascript
{
    type: 'log_message',
    level: 'INFO',
    message: 'Текст сообщения',
    timestamp: '2026-01-16T10:30:00.000Z',
    source: 'WS Server v4'
}
```

## Системные требования

- Node.js 14+
- Доступ к файлу лога SvxLink (`/var/log/svxlink`)
- PHP endpoint для начального состояния
- Права на запуск процесса `tail -F`

## Переменные окружения

`DEBUG_LEVEL` - уровень логирования (1-4)
```bash
DEBUG_LEVEL=4 node dashboard_ws_server.0.4.17.js
```

## Сигналы ОС

- **SIGINT** (Ctrl+C) - корректное завершение
- **SIGTERM** - корректное завершение

## Обработка ошибок

1. **Отсутствие лог-файла** - предупреждение, продолжение работы
2. **Ошибка PHP endpoint** - использование пустого состояния
3. **Ошибка WebSocket** - логирование, продолжение работы
4. **Ошибка tail процесса** - перезапуск через 2 секунды

## Производительность

- Буферизация логов: до 50 строк, таймаут 3 сек
- Чанкинг команд: по 10 команд в пакете
- Автоотключение: 15 секунд без клиентов
- Пинг-понг: поддержка клиентских ping

## Совместимость

- WebSocket клиент v4.2+
- SvxLink 1.8.0+
- Любой современный браузер с поддержкой WebSocket

## Мониторинг

Сервер предоставляет статистику через:
- Консольные логи (с уровнями)
- Сообщения `log_message` клиентам
- Метод `getStats()` для внешнего мониторинга